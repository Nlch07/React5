<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AstikChat | Premium</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, onValue, set, update, get, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDppgpIDC7lsqkyKanmWnt6aRmkV8sRfck",
            authDomain: "astikchat-2356f.firebaseapp.com",
            databaseURL: "https://astikchat-2356f-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "astikchat-2356f",
            storageBucket: "astikchat-2356f.firebasestorage.app",
            messagingSenderId: "481971458258",
            appId: "1:481971458258:web:131953007028cc61be5d0b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        window.fb = { 
            auth, db, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, 
            updateProfile, ref, push, onValue, set, update, get, remove
        };
    </script>

    <style>
        :root { --main-blue: #1565C0; --bg: #f0f2f5; --green: #25D366; --red: #ff3b30; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; margin: 0; font-family: -apple-system, sans-serif; background: #f0f2f5; overflow: hidden; }
        
        #root { display: flex; flex-direction: column; height: 100vh; height: 100dvh; background: white; max-width: 500px; margin: 0 auto; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); }

        header { background: var(--main-blue); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .logo { font-size: 1.5rem; font-weight: 900; margin: 0; }

        .top-menu { background: #fff; padding: 12px 15px; border-bottom: 1px solid #eee; }
        .menu-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .btn { border: none; background: #f0f2f5; color: #333; padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer; }
        .btn-online { background: #4CAF50; color: white; }
        
        .btn-delete { background: none; color: white; border: 1px solid white; padding: 5px 12px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; font-weight: 600; }

        .search-input { width: 100%; padding: 12px 15px; border-radius: 12px; border: none; background: #f0f2f5; outline: none; }

        .online-panel { padding: 15px; background: #fff; border-bottom: 8px solid #f0f2f5; }
        .section-title { font-size: 0.7rem; font-weight: 800; color: #999; text-transform: uppercase; margin-bottom: 10px; display: block; }
        .online-list { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 5px; }
        .online-user { display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; min-width: 65px; }

        .content-scroll { flex: 1; overflow-y: auto; }
        .chat-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #f5f5f5; cursor: pointer; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0; background: #ccc; position: relative; }
        .online-indicator { position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; background: #4CAF50; border: 2px solid white; border-radius: 50%; }
        .chat-info { flex: 1; margin-left: 15px; overflow: hidden; }
        .chat-name { font-weight: 700; display: block; margin-bottom: 2px; }
        .chat-preview { font-size: 0.9rem; color: #65676b; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: block; }
        
        .unread-badge { background: var(--green); color: white; border-radius: 50%; min-width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; margin-top: 5px; }

        .chat-area { flex: 1; overflow-y: auto; background: #e5ddd5; padding: 15px; display: flex; flex-direction: column; gap: 6px; }
        .date-separator { align-self: center; background: rgba(0,0,0,0.08); color: #555; padding: 4px 12px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; margin: 10px 0; text-transform: uppercase; }
        
        /* –ù–û–í–ê–Ø –ù–ê–î–ü–ò–°–¨ –ù–ï–ü–†–û–ß–ò–¢–ê–ù–ù–´–ï */
        .unread-separator { align-self: center; background: #fff; color: #666; padding: 6px 20px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; margin: 15px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); width: 100%; text-align: center; position: relative; }

        .msg-wrap { display: flex; width: 100%; cursor: pointer; }
        .my-wrap { justify-content: flex-end; }
        .msg-bubble { max-width: 80%; padding: 8px 12px; border-radius: 15px; font-size: 0.95rem; box-shadow: 0 1px 1px rgba(0,0,0,0.1); position: relative; word-break: break-word; }
        .my-bubble { background: #dcf8c6; border-bottom-right-radius: 2px; }
        .other-bubble { background: white; border-bottom-left-radius: 2px; }
        .msg-time { font-size: 0.65rem; color: #888; display: block; text-align: right; margin-top: 4px; }
        .chat-link { color: #007bff; text-decoration: underline; }

        .reply-in-msg { background: rgba(0,0,0,0.05); border-left: 3px solid var(--main-blue); padding: 5px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 5px; }

        .input-bar-container { background: white; border-top: 1px solid #eee; display: flex; flex-direction: column; }
        .reply-preview { padding: 8px 15px; background: #f8f9fa; border-left: 4px solid var(--main-blue); display: flex; justify-content: space-between; font-size: 0.85rem; }
        .input-bar { padding: 10px 15px; display: flex; gap: 10px; align-items: center; }
        .input-bar input { flex: 1; border: none; padding: 12px 18px; border-radius: 24px; background: #f0f2f5; outline: none; }
        .send-btn { background: var(--main-blue); color: white; border: none; border-radius: 50%; width: 42px; height: 42px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .typing-status { font-size: 0.75rem; color: #adff2f; font-weight: bold; }
        .dot { width: 6px; height: 6px; background: #999; border-radius: 50%; animation: typingAnimation 1.4s infinite; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingAnimation { 0%, 60%, 100% { transform: translateY(0); opacity: 0.4; } 30% { transform: translateY(-4px); opacity: 1; } }

        .login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #1565C0 0%, #1e88e5 100%); display: flex; align-items: center; justify-content: center; padding: 20px; z-index: 1000; }
        .login-card { background: white; padding: 40px 30px; border-radius: 28px; width: 100%; max-width: 360px; text-align: center; }
        .google-btn { display: flex; align-items: center; justify-content: center; gap: 12px; width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 14px; background: white; font-weight: 600; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState("hub");
            const [activeChat, setActiveChat] = useState(null);
            const [chatName, setChatName] = useState("");
            const [myChats, setMyChats] = useState([]);
            const [onlineUsers, setOnlineUsers] = useState([]);
            const [messages, setMessages] = useState([]);
            const [text, setText] = useState("");
            const [search, setSearch] = useState("");
            const [isPartnerTyping, setIsPartnerTyping] = useState(false);
            const [replyTo, setReplyTo] = useState(null);
            
            // –ù–û–í–û–ï: —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞ –ø–µ—Ä–≤–æ–≥–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            const [unreadIndex, setUnreadIndex] = useState(-1);
            
            const scrollRef = useRef();
            const holdTimer = useRef(null);

            useEffect(() => {
                return window.fb.onAuthStateChanged(window.fb.auth, u => { setUser(u); });
            }, []);

            useEffect(() => {
                if (user?.uid) {
                    return window.fb.onValue(window.fb.ref(window.fb.db, 'presence'), s => {
                        const val = s.val() || {};
                        const active = Object.entries(val)
                            .map(([uid, data]) => ({ uid, ...data }))
                            .filter(u => (Date.now() - u.lastSeen < 5 * 60 * 1000)); 
                        setOnlineUsers(active);
                    });
                }
            }, [user]);

            useEffect(() => {
                if (user?.uid) {
                    return window.fb.onValue(window.fb.ref(window.fb.db, `userChats/${user.uid}`), s => {
                        const val = s.val();
                        setMyChats(val ? Object.values(val).sort((a,b) => b.lastTime - a.lastTime) : []);
                    });
                }
            }, [user]);

            useEffect(() => {
                if (user && view === "chat" && activeChat) {
                    const chatId = [user.uid, activeChat].sort().join("_");
                    
                    // –£–∑–Ω–∞–µ–º, —Å–∫–æ–ª—å–∫–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –±—ã–ª–æ –¥–æ –≤—Ö–æ–¥–∞
                    const chatData = myChats.find(c => c.partnerUid === activeChat);
                    const count = chatData?.unread || 0;

                    const msgUnsub = window.fb.onValue(window.fb.ref(window.fb.db, `messages/private/${chatId}`), s => {
                        const data = s.val();
                        const msgList = data ? Object.entries(data).map(([id, val]) => ({ id, ...val })) : [];
                        setMessages(msgList);
                        
                        // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ, —Å—Ç–∞–≤–∏–º –º–∞—Ä–∫–µ—Ä –ø–µ—Ä–µ–¥ –Ω–∏–º–∏
                        if (count > 0 && msgList.length >= count) {
                            setUnreadIndex(msgList.length - count);
                        } else {
                            setUnreadIndex(-1);
                        }

                        setTimeout(() => scrollRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
                    });

                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ –ë–î
                    window.fb.update(window.fb.ref(window.fb.db, `userChats/${user.uid}/${activeChat}`), { unread: 0 });

                    const typingUnsub = window.fb.onValue(window.fb.ref(window.fb.db, `typing/${chatId}/${activeChat}`), s => {
                        setIsPartnerTyping(s.val() === true);
                    });
                    return () => { msgUnsub(); typingUnsub(); };
                }
            }, [view, activeChat, user]);

            const formatText = (txt) => {
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                return txt.split(urlRegex).map((part, i) => {
                    if (part.match(urlRegex)) {
                        return <a key={i} href={part} target="_blank" rel="noopener noreferrer" className="chat-link" onClick={e => e.stopPropagation()}>{part}</a>;
                    }
                    return part;
                });
            };

            const getDateLabel = (timestamp) => {
                const date = new Date(timestamp);
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                if (timestamp >= today) return "–°–µ–≥–æ–¥–Ω—è";
                if (timestamp >= today - 86400000) return "–í—á–µ—Ä–∞";
                return date.toLocaleDateString([], { day: 'numeric', month: 'long' });
            };

            const changeDisplayName = async () => {
                const newName = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è:", user.displayName);
                if (newName && newName.trim() !== "" && newName.trim() !== user.displayName) {
                    if (confirm(`–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è –Ω–∞ "${newName.trim()}"?`)) {
                        try {
                            await window.fb.updateProfile(window.fb.auth.currentUser, { displayName: newName.trim() });
                            const onlineRef = window.fb.ref(window.fb.db, `presence/${user.uid}`);
                            const snap = await window.fb.get(onlineRef);
                            if (snap.exists()) await window.fb.update(onlineRef, { name: newName.trim() });
                            window.location.reload();
                        } catch (e) { alert("–û—à–∏–±–∫–∞: " + e.message); }
                    }
                }
            };

            const toggleOnline = () => {
                const isOnline = onlineUsers.some(u => u.uid === user.uid);
                if (isOnline) {
                    window.fb.set(window.fb.ref(window.fb.db, `presence/${user.uid}`), null);
                } else {
                    window.fb.set(window.fb.ref(window.fb.db, `presence/${user.uid}`), {
                        name: user.displayName, lastSeen: Date.now()
                    });
                }
            };

            const handleTyping = (e) => {
                setText(e.target.value);
                const chatId = [user.uid, activeChat].sort().join("_");
                window.fb.set(window.fb.ref(window.fb.db, `typing/${chatId}/${user.uid}`), true);
                clearTimeout(window.tOut);
                window.tOut = setTimeout(() => {
                    window.fb.set(window.fb.ref(window.fb.db, `typing/${chatId}/${user.uid}`), false);
                }, 2000);
            };

            const sendMessage = async () => {
                if (!text.trim()) return;
                const time = Date.now(), chatId = [user.uid, activeChat].sort().join("_");
                const msgData = { text, uid: user.uid, time, reply: replyTo ? { text: replyTo.text, name: replyTo.name } : null };
                
                window.fb.push(window.fb.ref(window.fb.db, `messages/private/${chatId}`), msgData);
                window.fb.update(window.fb.ref(window.fb.db, `userChats/${user.uid}/${activeChat}`), { 
                    lastMsg: text, lastTime: time, partnerName: chatName, partnerUid: activeChat 
                });
                
                const partnerRef = window.fb.ref(window.fb.db, `userChats/${activeChat}/${user.uid}`);
                const snap = await window.fb.get(partnerRef);
                const currentUnread = (snap.val()?.unread || 0);
                
                window.fb.update(partnerRef, { 
                    lastMsg: text, lastTime: time, partnerName: user.displayName, 
                    partnerUid: user.uid, unread: currentUnread + 1 
                });

                setText(""); setReplyTo(null); setUnreadIndex(-1); // –°–∫—Ä—ã–≤–∞–µ–º –ª–∏–Ω–∏—é –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
                window.fb.set(window.fb.ref(window.fb.db, `typing/${chatId}/${user.uid}`), false);
            };

            const startHold = (msgId, isMy) => {
                if (!isMy) return;
                holdTimer.current = setTimeout(() => {
                    if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö?")) {
                        const chatId = [user.uid, activeChat].sort().join("_");
                        window.fb.remove(window.fb.ref(window.fb.db, `messages/private/${chatId}/${msgId}`));
                    }
                }, 800);
            };

            const stopHold = () => clearTimeout(holdTimer.current);

            if (!user) return (
                <div className="login-screen">
                    <div className="login-card">
                        <h1 style={{color:'var(--main-blue)'}}>AstikChat</h1>
                        <button className="google-btn" onClick={() => window.fb.signInWithPopup(window.fb.auth, new window.fb.GoogleAuthProvider())}>–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
                    </div>
                </div>
            );

            if (view === "hub") return (
                <>
                    <header>
                        <h1 className="logo">AstikChat</h1>
                        <button className="btn" onClick={() => confirm("–í—ã–π—Ç–∏?") && window.fb.signOut(window.fb.auth)}>–í—ã—Ö–æ–¥</button>
                    </header>
                    <div className="top-menu">
                        <div className="menu-row">
                            <div style={{display:'flex', alignItems:'center', gap:10}}>
                                <div className="avatar" style={{width:35, height:35, background:'var(--main-blue)'}}>{user.displayName?.[0]}</div>
                                <div style={{display:'flex', flexDirection:'column'}}>
                                    <b>{user.displayName}</b>
                                    <span onClick={changeDisplayName} style={{fontSize:'0.7rem', color:'var(--main-blue)', cursor:'pointer', fontWeight:'600'}}>–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è ‚úé</span>
                                </div>
                            </div>
                            <button className={`btn ${onlineUsers.some(u => u.uid === user.uid) ? '' : 'btn-online'}`} onClick={toggleOnline}>
                                {onlineUsers.some(u => u.uid === user.uid) ? "–£–π—Ç–∏ –≤ —Ç–µ–Ω—å" : "–Ø –æ–Ω–ª–∞–π–Ω"}
                            </button>
                        </div>
                        <input className="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –¥–∏–∞–ª–æ–≥–æ–≤..." value={search} onChange={e => setSearch(e.target.value)} />
                    </div>
                    <div className="content-scroll">
                        <div className="online-panel">
                            <span className="section-title">–í —Å–µ—Ç–∏</span>
                            <div className="online-list">
                                {onlineUsers.map(u => (
                                    <div key={u.uid} className="online-user" onClick={() => u.uid !== user.uid && (setActiveChat(u.uid), setChatName(u.name), setView("chat"))}>
                                        <div className="avatar" style={{background: u.uid === user.uid ? 'var(--main-blue)' : '#eee', border: '2px solid var(--green)'}}>{u.name?.[0]}<div className="online-indicator"></div></div>
                                        <span style={{fontWeight: u.uid === user.uid ? 'bold' : 'normal'}}>{u.uid === user.uid ? "–Ø" : u.name}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                        {myChats.filter(c => c.partnerName?.toLowerCase().includes(search.toLowerCase())).map(c => (
                            <div key={c.partnerUid} className="chat-item" onClick={() => {setActiveChat(c.partnerUid); setChatName(c.partnerName); setView("chat");}}>
                                <div className="avatar">{c.partnerName?.[0]}</div>
                                <div className="chat-info"><span className="chat-name">{c.partnerName}</span><span className="chat-preview">{c.lastMsg}</span></div>
                                <div style={{display:'flex', flexDirection:'column', alignItems:'flex-end', gap:2}}>
                                    <span style={{fontSize:'0.7rem', color: c.unread > 0 ? 'var(--green)' : '#999', fontWeight: c.unread > 0 ? 'bold' : 'normal'}}>
                                        {new Date(c.lastTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                    </span>
                                    {c.unread > 0 && <div className="unread-badge">{c.unread}</div>}
                                </div>
                            </div>
                        ))}
                    </div>
                </>
            );

            return (
                <>
                    <header>
                        <div style={{display:'flex', alignItems:'center', gap:12}}>
                            <span onClick={() => {setView("hub"); setUnreadIndex(-1);}} style={{fontSize:'1.5rem', cursor:'pointer'}}>‚Üê</span>
                            <div className="avatar" style={{width:35, height:35}}>{chatName?.[0]}</div>
                            <div>
                                <b style={{fontSize:'1rem'}}>{chatName}</b>
                                {isPartnerTyping && <div className="typing-status">–ø–µ—á–∞—Ç–∞–µ—Ç...</div>}
                            </div>
                        </div>
                        <button className="btn-delete" onClick={() => confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?") && (window.fb.remove(window.fb.ref(window.fb.db, `userChats/${user.uid}/${activeChat}`)), setView("hub"))}>–£–¥–∞–ª–∏—Ç—å</button>
                    </header>
                    <div className="chat-area">
                        {messages.map((m, i) => {
                            const isNewDay = i === 0 || getDateLabel(messages[i-1].time) !== getDateLabel(m.time);
                            const isFirstUnread = i === unreadIndex;
                            
                            return (
                                <React.Fragment key={m.id || i}>
                                    {isNewDay && <div className="date-separator">{getDateLabel(m.time)}</div>}
                                    
                                    {/* –†–ê–ó–î–ï–õ–ò–¢–ï–õ–¨ –ù–ï–ü–†–û–ß–ò–¢–ê–ù–ù–´–• –°–û–û–ë–©–ï–ù–ò–ô */}
                                    {isFirstUnread && <div className="unread-separator">–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div>}

                                    <div 
                                        className={`msg-wrap ${m.uid === user.uid ? 'my-wrap' : ''}`} 
                                        onClick={() => setReplyTo({text: m.text, name: m.uid === user.uid ? '–í—ã' : chatName})}
                                        onMouseDown={() => startHold(m.id, m.uid === user.uid)}
                                        onMouseUp={stopHold}
                                        onMouseLeave={stopHold}
                                        onTouchStart={() => startHold(m.id, m.uid === user.uid)}
                                        onTouchEnd={stopHold}
                                    >
                                        <div className={`msg-bubble ${m.uid === user.uid ? 'my-bubble' : 'other-bubble'}`}>
                                            {m.reply && <div className="reply-in-msg"><b>{m.reply.name}</b><br/>{m.reply.text}</div>}
                                            {formatText(m.text)}
                                            <span className="msg-time">{new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                                        </div>
                                    </div>
                                </React.Fragment>
                            );
                        })}
                        {isPartnerTyping && (
                            <div className="msg-wrap">
                                <div className="msg-bubble other-bubble" style={{display:'flex', gap:4, padding:'12px 16px', alignItems:'center'}}>
                                    <div className="dot"></div><div className="dot"></div><div className="dot"></div>
                                </div>
                            </div>
                        )}
                        <div ref={scrollRef} />
                    </div>
                    <div className="input-bar-container">
                        {replyTo && <div className="reply-preview"><span>–û—Ç–≤–µ—Ç <b>{replyTo.name}</b>: {replyTo.text}</span><span onClick={()=>setReplyTo(null)} style={{cursor:'pointer'}}>‚úï</span></div>}
                        <div className="input-bar">
                            <input value={text} onChange={handleTyping} onKeyPress={e => e.key === 'Enter' && sendMessage()} placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." />
                            <button className="send-btn" onClick={sendMessage}>‚û§</button>
                        </div>
                    </div>
                </>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
