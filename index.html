<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AstikChat | Premium</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDppgpIDC7lsqkyKanmWnt6aRmkV8sRfck",
            authDomain: "astikchat-2356f.firebaseapp.com",
            databaseURL: "https://astikchat-2356f-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "astikchat-2356f",
            storageBucket: "astikchat-2356f.firebasestorage.app",
            messagingSenderId: "481971458258",
            appId: "1:481971458258:web:131953007028cc61be5d0b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ window –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ Babel
        window.fb = { 
            auth, db, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, 
            updateProfile, ref, push, onValue, set, update 
        };
    </script>

    <style>
        :root { --main-blue: #1565C0; --bg: #f0f2f5; --green: #4CAF50; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; overflow: hidden; }
        
        #root { display: flex; flex-direction: column; height: 100vh; height: 100dvh; background: white; max-width: 500px; margin: 0 auto; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); }

        /* –î–∏–∑–∞–π–Ω –≤—Ö–æ–¥–∞ */
        .login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #1565C0 0%, #1e88e5 100%); display: flex; align-items: center; justify-content: center; padding: 20px; z-index: 1000; }
        .login-card { background: white; padding: 40px 30px; border-radius: 28px; width: 100%; max-width: 360px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .google-btn { display: flex; align-items: center; justify-content: center; gap: 12px; width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 14px; background: white; font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.2s; margin-top: 20px; }
        .google-btn:active { transform: scale(0.98); background: #f9f9f9; }
        .google-btn img { width: 20px; height: 20px; }

        header { background: var(--main-blue); color: white; padding: 15px 20px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .logo { font-size: 1.5rem; font-weight: 900; margin: 0; letter-spacing: -0.5px; }

        .top-menu { background: #fff; padding: 12px 15px; border-bottom: 1px solid #eee; }
        .menu-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .btn { border: none; background: #f0f2f5; color: #333; padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 0.85rem; }
        .btn-primary { background: var(--main-blue); color: white; }
        .btn-online { background: var(--green); color: white; }

        .search-input { width: 100%; padding: 12px 15px; border-radius: 12px; border: none; background: #f0f2f5; outline: none; font-size: 0.95rem; }

        /* –ü–∞–Ω–µ–ª—å –û–Ω–ª–∞–π–Ω */
        .online-panel { padding: 15px; background: #fff; border-bottom: 8px solid #f0f2f5; }
        .section-title { font-size: 0.7rem; font-weight: 800; color: #999; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; display: block; }
        .online-list { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .online-list::-webkit-scrollbar { display: none; }
        .online-user { display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; min-width: 65px; }
        .online-user span { font-size: 0.75rem; font-weight: 500; color: #333; width: 65px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .content-scroll { flex: 1; overflow-y: auto; background: white; }
        
        /* –ß–∞—Ç-—Å–ø–∏—Å–æ–∫ */
        .chat-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #f5f5f5; cursor: pointer; transition: 0.2s; }
        .chat-item:active { background: #f0f2f5; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0; font-size: 1.2rem; background: #ccc; position: relative; }
        .online-indicator { position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; background: var(--green); border: 2px solid white; border-radius: 50%; }
        .chat-info { flex: 1; margin-left: 15px; overflow: hidden; }
        .chat-name { font-weight: 700; color: #1c1e21; display: block; margin-bottom: 4px; }
        .chat-preview { font-size: 0.9rem; color: #65676b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }

        /* –û–∫–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π */
        .chat-area { flex: 1; overflow-y: auto; background: #e5ddd5; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg-wrap { display: flex; width: 100%; }
        .my-wrap { justify-content: flex-end; }
        .msg-bubble { max-width: 80%; padding: 8px 12px; border-radius: 18px; font-size: 0.95rem; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .my-bubble { background: #dcf8c6; border-bottom-right-radius: 4px; }
        .other-bubble { background: white; border-bottom-left-radius: 4px; }
        .msg-time { font-size: 0.65rem; color: #888; margin-top: 4px; display: block; text-align: right; }

        .input-bar { padding: 10px 15px; background: #fff; display: flex; gap: 10px; align-items: center; border-top: 1px solid #eee; }
        .input-bar input { flex: 1; border: none; padding: 12px 18px; border-radius: 24px; background: #f0f2f5; outline: none; font-size: 1rem; }
        .send-btn { background: var(--main-blue); color: white; border: none; border-radius: 50%; width: 42px; height: 42px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState("hub");
            const [activeChat, setActiveChat] = useState(null);
            const [chatName, setChatName] = useState("");
            const [myChats, setMyChats] = useState([]);
            const [onlineUsers, setOnlineUsers] = useState([]);
            const [messages, setMessages] = useState([]);
            const [text, setText] = useState("");
            const [search, setSearch] = useState("");
            const [inputName, setInputName] = useState("");
            const scrollRef = useRef();

            // 1. –°–ª–µ–¥–∏–º –∑–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
            useEffect(() => {
                return window.fb.onAuthStateChanged(window.fb.auth, u => {
                    setUser(u);
                    if (u?.displayName) setInputName(u.displayName);
                });
            }, []);

            // 2. –°–ª–µ–¥–∏–º –∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –æ–Ω–ª–∞–π–Ω (–≤–∫–ª—é—á–∞—è —Å–µ–±—è)
                useEffect(() => {
                    if (user?.displayName) {
                        return window.fb.onValue(window.fb.ref(window.fb.db, 'presence'), s => {
                            const val = s.val() || {};
                            const active = Object.entries(val)
                                .map(([uid, data]) => ({ uid, ...data }))
                                // –£–±—Ä–∞–ª–∏ —Ñ–∏–ª—å—Ç—Ä u.uid !== user.uid, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∏ —Å–µ–±—è
                                .filter(u => (Date.now() - u.lastSeen < 5 * 60 * 1000)); 
                            setOnlineUsers(active);
                        });
                    }
                }, [user]);
            // 3. –°–ø–∏—Å–æ–∫ –º–æ–∏—Ö –ø–µ—Ä–µ–ø–∏—Å–æ–∫
            useEffect(() => {
                if (user?.uid) {
                    return window.fb.onValue(window.fb.ref(window.fb.db, `userChats/${user.uid}`), s => {
                        const val = s.val();
                        setMyChats(val ? Object.values(val).sort((a,b) => b.lastTime - a.lastTime) : []);
                    });
                }
            }, [user]);

            // 4. –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —á–∞—Ç–µ
            useEffect(() => {
                if (user && view === "chat") {
                    const path = `messages/private/${[user.uid, activeChat].sort().join("_")}`;
                    return window.fb.onValue(window.fb.ref(window.fb.db, path), s => {
                        setMessages(s.val() ? Object.values(s.val()) : []);
                        setTimeout(() => scrollRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
                    });
                }
            }, [view, activeChat, user]);

            const login = async () => {
                const provider = new window.fb.GoogleAuthProvider();
                try { await window.fb.signInWithPopup(window.fb.auth, provider); } 
                catch (e) { alert("–û—à–∏–±–∫–∞: " + e.message); }
            };

            const finishRegistration = async () => {
                if (inputName.trim().length < 2) return alert("–ù–∏–∫–Ω–µ–π–º —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π");
                await window.fb.updateProfile(window.fb.auth.currentUser, { displayName: inputName });
                setUser({...window.fb.auth.currentUser, displayName: inputName});
            };

            const setIMOnline = () => {
                window.fb.set(window.fb.ref(window.fb.db, `presence/${user.uid}`), {
                    name: user.displayName,
                    lastSeen: Date.now()
                });
                alert("–í—ã –≤ —Å–ø–∏—Å–∫–µ –æ–Ω–ª–∞–π–Ω –Ω–∞ 5 –º–∏–Ω—É—Ç!");
            };

            const openChat = (uid, name) => {
                setActiveChat(uid);
                setChatName(name);
                setView("chat");
            };

            const sendMessage = () => {
                if (!text.trim()) return;
                const time = Date.now();
                const chatId = [user.uid, activeChat].sort().join("_");
                const path = `messages/private/${chatId}`;
                
                window.fb.push(window.fb.ref(window.fb.db, path), { text, uid: user.uid, time });
                
                const updateData = { lastMsg: text, lastTime: time };
                window.fb.update(window.fb.ref(window.fb.db, `userChats/${user.uid}/${activeChat}`), { ...updateData, partnerName: chatName, partnerUid: activeChat });
                window.fb.update(window.fb.ref(window.fb.db, `userChats/${activeChat}/${user.uid}`), { ...updateData, partnerName: user.displayName, partnerUid: user.uid });
                
                setText("");
            };

            // –≠–ö–†–ê–ù 1: –í–•–û–î –ß–ï–†–ï–ó GOOGLE
            if (!user) {
                return (
                    <div className="login-screen">
                        <div className="login-card">
                            <h1 style={{color:'var(--main-blue)', fontSize:'2rem', marginBottom:10}}>AstikChat</h1>
                            <p style={{color:'#666', fontSize:'0.9rem'}}>–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
                            <button className="google-btn" onClick={login}>
                                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/layout/google.svg" />
                                –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
                            </button>
                        </div>
                    </div>
                );
            }

            // –≠–ö–†–ê–ù 2: –í–´–ë–û–† –ù–ò–ö–ù–ï–ô–ú–ê
            if (!user.displayName) {
                return (
                    <div className="login-screen">
                        <div className="login-card">
                            <h3>–í–∞—à –Ω–∏–∫–Ω–µ–π–º</h3>
                            <input className="search-input" style={{margin:'15px 0', textAlign:'center'}} 
                                   value={inputName} onChange={e => setInputName(e.target.value)} placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∏–∫..." />
                            <button className="btn btn-primary" style={{width:'100%', padding:12}} onClick={finishRegistration}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –≤–æ–π—Ç–∏</button>
                        </div>
                    </div>
                );
            }

            // –≠–ö–†–ê–ù 3: –ì–õ–ê–í–ù–´–ô –•–ê–ë
            if (view === "hub") {
                return (
                    <>
                        <header>
                            <h1 className="logo">AstikChat</h1>
                            <button className="btn" onClick={() => window.fb.signOut(window.fb.auth)}>–í—ã—Ö–æ–¥</button>
                        </header>
                        
                        <div className="top-menu">
                            <div className="menu-row">
                                <div style={{display:'flex', alignItems:'center', gap:10}}>
                                    <div className="avatar" style={{width:35, height:35, fontSize:'0.9rem', background:'var(--main-blue)'}}>{user.displayName[0]}</div>
                                    <b style={{fontSize:'0.9rem'}}>{user.displayName}</b>
                                </div>
                                <button className="btn btn-online" onClick={setIMOnline}>–Ø –æ–Ω–ª–∞–π–Ω</button>
                            </div>
                            <input className="search-input" placeholder="üîç –ü–æ–∏—Å–∫ —Å–æ–æ–±—â–µ–Ω–∏–π..." value={search} onChange={e => setSearch(e.target.value)} />
                        </div>

                        <div className="content-scroll">
                            <div className="online-panel">
                                <span className="section-title">–°–µ–π—á–∞—Å –≤ —Å–µ—Ç–∏</span>
<div className="online-list">
    {onlineUsers.length === 0 && <div style={{color:'#ccc', fontSize:'0.8rem', padding:10}}>–ù–∏–∫–æ–≥–æ –Ω–µ—Ç –æ–Ω–ª–∞–π–Ω...</div>}
    {onlineUsers.map(u => (
        <div key={u.uid} className="online-user" onClick={() => u.uid !== user.uid && openChat(u.uid, u.name)}>
            <div className="avatar" style={{
                background: u.uid === user.uid ? 'var(--main-blue)' : '#eee', 
                color: u.uid === user.uid ? 'white' : '#333', 
                border: '2px solid var(--green)'
            }}>
                {u.name[0]}
                <div className="online-indicator"></div>
            </div>
            <span style={{fontWeight: u.uid === user.uid ? 'bold' : 'normal'}}>
                {u.uid === user.uid ? "–Ø (–æ–Ω–ª–∞–π–Ω)" : u.name}
            </span>
        </div>
    ))}
</div>
                            </div>

                            <span className="section-title" style={{padding:'15px 15px 5px'}}>–ú–æ–∏ –¥–∏–∞–ª–æ–≥–∏</span>
                            {myChats.filter(c => c.partnerName?.toLowerCase().includes(search.toLowerCase())).map(c => (
                                <div key={c.partnerUid} className="chat-item" onClick={() => openChat(c.partnerUid, c.partnerName)}>
                                    <div className="avatar">{c.partnerName[0]}</div>
                                    <div className="chat-info">
                                        <span className="chat-name">{c.partnerName}</span>
                                        <span className="chat-preview">{c.lastMsg}</span>
                                    </div>
                                    <span style={{fontSize:'0.7rem', color:'#999'}}>{new Date(c.lastTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                                </div>
                            ))}
                        </div>
                    </>
                );
            }

            // –≠–ö–†–ê–ù 4: –û–ö–ù–û –ß–ê–¢–ê
            return (
                <>
                    <header>
                        <div style={{display:'flex', alignItems:'center', gap:15}}>
                            <span onClick={() => setView("hub")} style={{fontSize:'1.5rem', cursor:'pointer'}}>‚Üê</span>
                            <div className="avatar" style={{width:35, height:35, fontSize:'0.9rem'}}>{chatName[0]}</div>
                            <b style={{fontSize:'1rem'}}>{chatName}</b>
                        </div>
                    </header>
                    <div className="chat-area">
                        {messages.map((m, i) => (
                            <div key={i} className={`msg-wrap ${m.uid === user.uid ? 'my-wrap' : ''}`}>
                                <div className={`msg-bubble ${m.uid === user.uid ? 'my-bubble' : 'other-bubble'}`}>
                                    {m.text}
                                    <span className="msg-time">{new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                                </div>
                            </div>
                        ))}
                        <div ref={scrollRef} />
                    </div>
                    <div className="input-bar">
                        <input value={text} onChange={e => setText(e.target.value)} 
                               onKeyPress={e => e.key === 'Enter' && sendMessage()} placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." />
                        <button className="send-btn" onClick={sendMessage}>‚û§</button>
                    </div>
                </>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
