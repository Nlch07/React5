<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AstikChat</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDppgpIDC7lsqkyKanmWnt6aRmkV8sRfck",
            authDomain: "astikchat-2356f.firebaseapp.com",
            databaseURL: "https://astikchat-2356f-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "astikchat-2356f",
            storageBucket: "astikchat-2356f.firebasestorage.app",
            messagingSenderId: "481971458258",
            appId: "1:481971458258:web:131953007028cc61be5d0b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        window.fb = { auth, db, signInAnonymously, signOut, onAuthStateChanged, updateProfile, ref, push, onValue, set, update };
    </script>

    <style>
        :root { --main-blue: #1565C0; --bg: #e5ddd5; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; margin: 0; overflow: hidden; font-family: -apple-system, sans-serif; }
        
        /* –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω –±–µ–∑ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ body */
        #root { display: flex; flex-direction: column; height: 100vh; height: 100dvh; background: white; max-width: 600px; margin: 0 auto; position: relative; }

        header { background: var(--main-blue); color: white; padding: 15px; text-align: center; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .logo { font-size: 1.8rem; font-weight: 900; margin: 0; }

        .top-menu { background: #f0f4f8; padding: 10px; display: flex; flex-direction: column; gap: 8px; border-bottom: 1px solid #ddd; }
        .menu-row { display: flex; justify-content: space-between; align-items: center; }
        .btn { border: 1px solid var(--main-blue); background: white; color: var(--main-blue); padding: 6px 12px; border-radius: 15px; font-weight: bold; cursor: pointer; font-size: 0.8rem; }
        .btn-exit { border-color: #d32f2f; color: #d32f2f; }

        .search-area { padding: 8px; background: white; }
        .search-input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; outline: none; }

        /* –û–±–ª–∞—Å—Ç—å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å–ø–∏—Å–∫–æ–≤ –∏ —á–∞—Ç–∞ */
        .content-scroll { flex: 1; overflow-y: auto; background: #fff; }
        .chat-area { flex: 1; overflow-y: auto; background: var(--bg); display: flex; flex-direction: column; padding: 10px; }

        .chat-item { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .chat-item:active { background: #f9f9f9; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0; }
        .chat-info { flex: 1; margin-left: 12px; overflow: hidden; }
        .chat-name { font-weight: bold; color: #333; display: block; }
        .chat-preview { font-size: 0.85rem; color: #777; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .msg-wrap { display: flex; width: 100%; margin-bottom: 8px; }
        .my-wrap { justify-content: flex-end; }
        .msg-bubble { max-width: 85%; padding: 8px 12px; border-radius: 15px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.2); font-size: 0.95rem; }
        .my-bubble { background: #dcf8c6; color: #000; border-bottom-right-radius: 2px; }
        .other-bubble { background: #fff; color: #000; border-bottom-left-radius: 2px; }
        .msg-time { font-size: 0.65rem; color: #888; display: block; text-align: right; margin-top: 3px; }

        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
        .input-bar { padding: 10px; background: #f0f0f0; display: flex; gap: 8px; flex-shrink: 0; border-top: 1px solid #ccc; }
        .input-bar input { flex: 1; border: none; padding: 10px 15px; border-radius: 20px; outline: none; font-size: 1rem; }
        .send-btn { background: var(--main-blue); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem; }

        /* –ú–æ–¥–∞–ª–∫–∏ */
        .modal { position: absolute; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
        .modal-box { background: white; padding: 20px; border-radius: 15px; width: 100%; max-width: 300px; text-align: center; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState("hub");
            const [activeChat, setActiveChat] = useState(null);
            const [chatName, setChatName] = useState("");
            const [myChats, setMyChats] = useState([]);
            const [messages, setMessages] = useState([]);
            const [text, setText] = useState("");
            const [search, setSearch] = useState("");
            const [modal, setModal] = useState(null); // 'exit', 'name', 'contact'
            const [inputName, setInputName] = useState("");
            const scrollRef = useRef();

            useEffect(() => {
                return window.fb.onAuthStateChanged(window.fb.auth, u => setUser(u));
            }, []);

            useEffect(() => {
                if (user?.uid) {
                    return window.fb.onValue(window.fb.ref(window.fb.db, `userChats/${user.uid}`), s => {
                        const val = s.val();
                        setMyChats(val ? Object.values(val).sort((a,b) => b.lastTime - a.lastTime) : []);
                    });
                }
            }, [user]);

            useEffect(() => {
                if (user && view === "chat") {
                    const path = activeChat === "public" ? 'messages/public' : `messages/private/${[user.uid, activeChat].sort().join("_")}`;
                    return window.fb.onValue(window.fb.ref(window.fb.db, path), s => {
                        setMessages(s.val() ? Object.values(s.val()) : []);
                        setTimeout(() => scrollRef.current?.scrollIntoView({ behavior: 'smooth' }), 50);
                    });
                }
            }, [view, activeChat, user]);

            const sendMessage = () => {
                if (!text.trim()) return;
                const time = Date.now();
                const path = activeChat === "public" ? 'messages/public' : `messages/private/${[user.uid, activeChat].sort().join("_")}`;
                window.fb.push(window.fb.ref(window.fb.db, path), { text, uid: user.uid, name: user.displayName, time });
                
                if (activeChat !== "public") {
                    const updateData = { lastMsg: text, lastTime: time, partnerUid: activeChat };
                    window.fb.update(window.fb.ref(window.fb.db, `userChats/${user.uid}/${activeChat}`), { ...updateData, partnerName: chatName });
                    window.fb.update(window.fb.ref(window.fb.db, `userChats/${activeChat}/${user.uid}`), { ...updateData, partnerName: user.displayName, partnerUid: user.uid });
                }
                setText("");
            };

            const openChat = (uid, name) => {
                setActiveChat(uid);
                setChatName(name);
                setView("chat");
            };

            if (!user) return <div className="modal"><button className="btn" onClick={() => window.fb.signInAnonymously(window.fb.auth)}>–í–æ–π—Ç–∏ –≤ AstikChat</button></div>;

            return (
                <div id="root">
                    {/* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */}
                    {modal === 'exit' && <div className="modal"><div className="modal-box"><p>–£–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?</p>
                        <button className="btn btn-exit" onClick={() => window.fb.signOut(window.fb.auth)}>–î–∞</button>
                        <button className="btn" onClick={() => setModal(null)}>–ù–µ—Ç</button>
                    </div></div>}

                    {modal === 'name' && <div className="modal"><div className="modal-box"><h3>–í–∞—à–µ –∏–º—è</h3>
                        <input value={inputName} onChange={e => setInputName(e.target.value)} style={{width:'100%', padding:8, marginBottom:10}} />
                        <button className="btn" onClick={async () => {
                            await window.fb.updateProfile(window.fb.auth.currentUser, { displayName: inputName });
                            setUser({...window.fb.auth.currentUser, displayName: inputName}); setModal(null);
                        }}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div></div>}

                    {modal === 'contact' && <div className="modal"><div className="modal-box"><h3>–ó–∞–ø–∏—Å–∞—Ç—å –∫–∞–∫</h3>
                        <input value={inputName} onChange={e => setInputName(e.target.value)} style={{width:'100%', padding:8, marginBottom:10}} />
                        <button className="btn" onClick={() => {
                            window.fb.update(window.fb.ref(window.fb.db, `userChats/${user.uid}/${activeChat}`), { partnerName: inputName });
                            setChatName(inputName); setModal(null);
                        }}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div></div>}

                    {view === "hub" ? (
                        <>
                            <header><h1 className="logo">AstikChat</h1></header>
                            <div className="top-menu">
                                <div className="menu-row">
                                    <span>üë§ <b>{user.displayName || "–ë–µ–∑ –∏–º–µ–Ω–∏"}</b></span>
                                    <div>
                                        <button className="btn" onClick={() => {setInputName(user.displayName); setModal('name')}}>–ò–º—è</button>
                                        <button className="btn btn-exit" style={{marginLeft:5}} onClick={() => setModal('exit')}>–í—ã—Ö–æ–¥</button>
                                    </div>
                                </div>
                                <input className="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤..." value={search} onChange={e => setSearch(e.target.value)} />
                            </div>
                            <div className="content-scroll">
                                {/* –û–ë–©–ò–ô –ß–ê–¢ - –í–°–ï–ì–î–ê –¢–£–¢ */}
                                <div className="chat-item" onClick={() => openChat("public", "üì¢ –û–±—â–∏–π —á–∞—Ç")} style={{background:'#e3f2fd'}}>
                                    <div className="avatar" style={{background: '#1565C0'}}>#</div>
                                    <div className="chat-info"><b className="chat-name">–û–±—â–∏–π —á–∞—Ç</b><span className="chat-preview">–ù–∞–ø–∏—Å–∞—Ç—å –≤—Å–µ–º...</span></div>
                                </div>
                                {/* –õ–ò–ß–ù–´–ï –ß–ê–¢–´ */}
                                {myChats.filter(c => c.partnerName?.toLowerCase().includes(search.toLowerCase())).map(c => (
                                    <div key={c.partnerUid} className="chat-item" onClick={() => openChat(c.partnerUid, c.partnerName)}>
                                        <div className="avatar" style={{background: '#999'}}>{c.partnerName[0]}</div>
                                        <div className="chat-info"><b className="chat-name">{c.partnerName}</b><span className="chat-preview">{c.lastMsg}</span></div>
                                    </div>
                                ))}
                            </div>
                        </>
                    ) : (
                        <>
                            <header style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                <span onClick={() => setView("hub")} style={{fontSize:'1.5rem', cursor:'pointer'}}>‚Üê</span>
                                <b onClick={() => { if(activeChat !== "public") {setInputName(chatName); setModal('contact')} }}>
                                    {chatName} {activeChat !== 'public' && '‚úèÔ∏è'}
                                </b>
                                <div style={{width:25}}></div>
                            </header>
                            <div className="chat-area">
                                {messages.map((m, i) => (
                                    <div key={i} className={`msg-wrap ${m.uid === user.uid ? 'my-wrap' : ''}`}>
                                        {m.uid !== user.uid && activeChat === 'public' && (
                                            <div className="avatar" style={{width:30, height:30, fontSize:12, marginRight:5, background:'#1565C0'}} onClick={() => openChat(m.uid, m.name)}>{m.name[0]}</div>
                                        )}
                                        <div className={`msg-bubble ${m.uid === user.uid ? 'my-bubble' : 'other-bubble'}`}>
                                            {activeChat === 'public' && m.uid !== user.uid && <div style={{fontSize:10, fontWeight:'bold', color: '#1565C0'}}>{m.name}</div>}
                                            {m.text}
                                            <span className="msg-time">{new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                                        </div>
                                    </div>
                                ))}
                                <div ref={scrollRef} />
                            </div>
                            <div className="input-bar">
                                <input value={text} onChange={e => setText(e.target.value)} onKeyPress={e => e.key === 'Enter' && sendMessage()} placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." />
                                <button className="send-btn" onClick={sendMessage}>‚û§</button>
                            </div>
                        </>
                    )}
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
