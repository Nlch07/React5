<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Astik Chat Hub</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInAnonymously, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDppgpIDC7lsqkyKanmWnt6aRmkV8sRfck",
            authDomain: "astikchat-2356f.firebaseapp.com",
            databaseURL: "https://astikchat-2356f-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "astikchat-2356f",
            storageBucket: "astikchat-2356f.firebasestorage.app",
            messagingSenderId: "481971458258",
            appId: "1:481971458258:web:131953007028cc61be5d0b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        window.fb = { auth, db, googleProvider: new GoogleAuthProvider(), signInWithPopup, signInAnonymously, signOut, onAuthStateChanged, updateProfile, ref, push, onValue, set, update };
    </script>

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, sans-serif; background-color: #f0f2f5; height: 100dvh; overflow: hidden; }
        #root { width: 100%; height: 100%; max-width: 500px; margin: 0 auto; background: white; display: flex; flex-direction: column; position: relative; }
        header { background: #075e54; color: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .chat-info { flex: 1; margin-left: 12px; }
        .chat-name { font-weight: bold; }
        .chat-last-msg { font-size: 0.8rem; color: #666; }
        .messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; background: #e5ddd5; }
        .msg-container { display: flex; align-items: flex-end; }
        .my-msg-container { justify-content: flex-end; }
        .msg { background: white; padding: 8px 12px; border-radius: 12px; max-width: 80%; box-shadow: 0 1px 1px rgba(0,0,0,0.1); font-size: 0.95rem; }
        .my-msg { background: #dcf8c6; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; color: white; display: flex; justify-content: center; align-items: center; font-weight: bold; flex-shrink: 0; }
        .input-area { background: #f0f0f0; padding: 10px; display: flex; gap: 8px; }
        input { flex: 1; border: none; padding: 12px; border-radius: 20px; outline: none; }
        
        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal { position: absolute; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; width: 100%; max-width: 300px; text-align: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; font-weight: bold; }
        .btn-danger { background: #ea4335; color: white; }
        .btn-ok { background: #075e54; color: white; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const getColor = (uid) => {
            let hash = 0;
            for (let i = 0; i < uid.length; i++) hash = uid.charCodeAt(i) + ((hash << 5) - hash);
            return `hsl(${Math.abs(hash) % 360}, 60%, 40%)`;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState("hub"); 
            const [activeChat, setActiveChat] = useState("public");
            const [chatPartnerName, setChatPartnerName] = useState("");
            const [myChats, setMyChats] = useState([]);
            const [messages, setMessages] = useState([]);
            const [text, setText] = useState("");
            const [showExitConfirm, setShowExitConfirm] = useState(false);
            const [showRenameSelf, setShowRenameSelf] = useState(false);
            const [showRenamePartner, setShowRenamePartner] = useState(false);
            const [newName, setNewName] = useState("");
            const scrollRef = useRef();

            useEffect(() => {
                return window.fb.onAuthStateChanged(window.fb.auth, (u) => setUser(u));
            }, []);

            useEffect(() => {
                if (!user || !user.displayName) return;
                const chatsRef = window.fb.ref(window.fb.db, `userChats/${user.uid}`);
                return window.fb.onValue(chatsRef, (snap) => {
                    const data = snap.val();
                    setMyChats(data ? Object.values(data).sort((a,b) => b.lastTime - a.lastTime) : []);
                });
            }, [user]);

            useEffect(() => {
                if (!user || view !== "chat") return;
                let path = activeChat === "public" ? 'messages/public' : `messages/private/${[user.uid, activeChat].sort().join("_")}`;
                return window.fb.onValue(window.fb.ref(window.fb.db, path), (snap) => {
                    setMessages(snap.val() ? Object.values(snap.val()) : []);
                    setTimeout(() => scrollRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
                });
            }, [user, view, activeChat]);

            const changeMyName = async () => {
                if (!newName.trim()) return;
                await window.fb.updateProfile(window.fb.auth.currentUser, { displayName: newName });
                setUser({...window.fb.auth.currentUser, displayName: newName});
                setShowRenameSelf(false);
            };

            const renamePartner = async () => {
                if (!newName.trim()) return;
                await window.fb.update(window.fb.ref(window.fb.db, `userChats/${user.uid}/${activeChat}`), { partnerName: newName });
                setChatPartnerName(newName);
                setShowRenamePartner(false);
            };

            const sendMessage = () => {
                if (!text.trim()) return;
                const time = Date.now();
                const path = activeChat === "public" ? 'messages/public' : `messages/private/${[user.uid, activeChat].sort().join("_")}`;
                window.fb.push(window.fb.ref(window.fb.db, path), { text, uid: user.uid, name: user.displayName, time });
                if (activeChat !== "public") {
                    window.fb.update(window.fb.ref(window.fb.db, `userChats/${user.uid}/${activeChat}`), { lastMsg: text, lastTime: time, partnerName: chatPartnerName, partnerUid: activeChat });
                    window.fb.update(window.fb.ref(window.fb.db, `userChats/${activeChat}/${user.uid}`), { lastMsg: text, lastTime: time, partnerName: user.displayName, partnerUid: user.uid });
                }
                setText("");
            };

            if (!user) return <div className="modal"><button onClick={() => window.fb.signInAnonymously(window.fb.auth)}>–í–æ–π—Ç–∏ –∞–Ω–æ–Ω–∏–º–Ω–æ</button></div>;

            return (
                <div id="root">
                    {/* –ú–æ–¥–∞–ª–∫–∞: –í—ã—Ö–æ–¥ */}
                    {showExitConfirm && (
                        <div className="modal">
                            <div className="modal-content">
                                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?</p>
                                <button className="btn btn-danger" onClick={() => window.fb.signOut(window.fb.auth)}>–î–∞, –≤—ã–π—Ç–∏</button>
                                <button className="btn" onClick={() => setShowExitConfirm(false)}>–û—Ç–º–µ–Ω–∞</button>
                            </div>
                        </div>
                    )}

                    {/* –ú–æ–¥–∞–ª–∫–∞: –°–º–µ–Ω–∞ —Å–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏ */}
                    {showRenameSelf && (
                        <div className="modal">
                            <div className="modal-content">
                                <p>–ù–æ–≤–æ–µ –∏–º—è:</p>
                                <input value={newName} onChange={e => setNewName(e.target.value)} autoFocus />
                                <button className="btn btn-ok" onClick={changeMyName}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                <button className="btn" onClick={() => setShowRenameSelf(false)}>–û—Ç–º–µ–Ω–∞</button>
                            </div>
                        </div>
                    )}

                    {/* –ú–æ–¥–∞–ª–∫–∞: –°–º–µ–Ω–∞ –∏–º–µ–Ω–∏ –¥—Ä—É–≥–∞ */}
                    {showRenamePartner && (
                        <div className="modal">
                            <div className="modal-content">
                                <p>–ö–∞–∫ –Ω–∞–∑–≤–∞—Ç—å —ç—Ç–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞?</p>
                                <input value={newName} onChange={e => setNewName(e.target.value)} autoFocus />
                                <button className="btn btn-ok" onClick={renamePartner}>–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
                                <button className="btn" onClick={() => setShowRenamePartner(false)}>–û—Ç–º–µ–Ω–∞</button>
                            </div>
                        </div>
                    )}

                    {view === "hub" ? (
                        <>
                            <header>
                                <b onClick={() => {setNewName(user.displayName); setShowRenameSelf(true)}} style={{cursor:'pointer'}}>‚öôÔ∏è {user.displayName}</b>
                                <button onClick={() => setShowExitConfirm(true)} style={{background:'none', border:'none', color:'white', fontSize:'1.2rem'}}>üö™</button>
                            </header>
                            <div className="chat-list">
                                <div className="chat-item" onClick={() => {setActiveChat("public"); setChatPartnerName("–û–±—â–∏–π —á–∞—Ç"); setView("chat")}}>
                                    <div className="avatar" style={{background: '#075e54'}}>#</div>
                                    <div className="chat-info"><div className="chat-name">–û–±—â–∏–π —á–∞—Ç</div></div>
                                </div>
                                {myChats.map(chat => (
                                    <div key={chat.partnerUid} className="chat-item" onClick={() => {setActiveChat(chat.partnerUid); setChatPartnerName(chat.partnerName); setView("chat")}}>
                                        <div className="avatar" style={{background: getColor(chat.partnerUid)}}>{chat.partnerName[0]}</div>
                                        <div className="chat-info">
                                            <div className="chat-name">{chat.partnerName}</div>
                                            <div className="chat-last-msg">{chat.lastMsg}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </>
                    ) : (
                        <>
                            <header>
                                <span onClick={() => setView("hub")}>‚Üê</span>
                                <b onClick={() => { if(activeChat !== "public") {setNewName(chatPartnerName); setShowRenamePartner(true)}} } style={{cursor: activeChat !== 'public' ? 'pointer' : 'default'}}>
                                    {chatPartnerName} {activeChat !== 'public' && '‚úèÔ∏è'}
                                </b>
                                <span></span>
                            </header>
                            <div className="messages">
                                {messages.map((m, i) => (
                                    <div key={i} className={`msg-container ${m.uid === user.uid ? 'my-msg-container' : ''}`}>
                                        <div className={`msg ${m.uid === user.uid ? 'my-msg' : ''}`}>
                                            {activeChat === 'public' && m.uid !== user.uid && <div style={{fontSize:'0.7rem', color: getColor(m.uid), fontWeight:'bold'}} onClick={() => {setActiveChat(m.uid); setChatPartnerName(m.name);}}>{m.name}</div>}
                                            {m.text}
                                        </div>
                                    </div>
                                ))}
                                <div ref={scrollRef} />
                            </div>
                            <div className="input-area">
                                <input value={text} onChange={e => setText(e.target.value)} onKeyPress={e => e.key === 'Enter' && sendMessage()} placeholder="–ù–∞–ø–∏—Å–∞—Ç—å..." />
                                <button onClick={sendMessage} style={{background:'#075e54', color:'white', border:'none', borderRadius:'50%', width:40, height:40}}>‚û§</button>
                            </div>
                        </>
                    )}
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
