<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AstikChat | Premium</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, onValue, set, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDppgpIDC7lsqkyKanmWnt6aRmkV8sRfck",
            authDomain: "astikchat-2356f.firebaseapp.com",
            databaseURL: "https://astikchat-2356f-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "astikchat-2356f",
            storageBucket: "astikchat-2356f.firebasestorage.app",
            messagingSenderId: "481971458258",
            appId: "1:481971458258:web:131953007028cc61be5d0b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        window.fb = { 
            auth, db, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, 
            updateProfile, ref, push, onValue, set, update, get 
        };
    </script>

    <style>
        :root { --main-blue: #1565C0; --bg: #f0f2f5; --green: #4CAF50; --red: #ff3b30; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: #f0f2f5; overflow: hidden; }
        #root { display: flex; flex-direction: column; height: 100vh; height: 100dvh; max-width: 500px; margin: 0 auto; background: white; position: relative; }

        header { background: var(--main-blue); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .logo { font-size: 1.5rem; font-weight: 900; margin: 0; }

        /* –≠–∫—Ä–∞–Ω—ã */
        .login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #1565C0 0%, #1e88e5 100%); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-card { background: white; padding: 40px; border-radius: 28px; width: 90%; max-width: 360px; text-align: center; }

        .top-menu { background: #fff; padding: 12px 15px; border-bottom: 1px solid #eee; }
        .menu-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .btn { border: none; background: #f0f2f5; padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer; }
        .btn-online { background: var(--green); color: white; }

        .content-scroll { flex: 1; overflow-y: auto; background: white; }
        .chat-area { flex: 1; overflow-y: auto; background: #e5ddd5; padding: 15px; display: flex; flex-direction: column; gap: 8px; }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .msg-wrap { display: flex; width: 100%; }
        .my-wrap { justify-content: flex-end; }
        .msg-bubble { max-width: 80%; padding: 8px 12px; border-radius: 18px; font-size: 0.95rem; box-shadow: 0 1px 1px rgba(0,0,0,0.1); position: relative; }
        .my-bubble { background: #dcf8c6; border-bottom-right-radius: 4px; }
        .other-bubble { background: white; border-bottom-left-radius: 4px; }
        .msg-time { font-size: 0.65rem; color: #888; text-align: right; margin-top: 4px; }

        /* –ì–æ–ª–æ—Å–æ–≤—ã–µ */
        .audio-msg { width: 100%; max-width: 210px; height: 35px; margin-top: 5px; display: block; }
        .mic-btn { background: var(--red); color: white; border: none; border-radius: 50%; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; }
        .mic-btn.recording { animation: pulse 1.2s infinite; background: #d32f2f; }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(255, 59, 48, 0); } 100% { transform: scale(1); } }

        .input-bar { padding: 10px 15px; display: flex; gap: 10px; align-items: center; background: white; border-top: 1px solid #eee; }
        .input-bar input { flex: 1; border: none; padding: 12px 18px; border-radius: 24px; background: #f0f2f5; outline: none; }
        .send-btn { background: var(--main-blue); color: white; border: none; border-radius: 50%; width: 42px; height: 42px; cursor: pointer; }

        .avatar { width: 40px; height: 40px; border-radius: 50%; background: #ccc; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; position: relative; }
        .online-indicator { position: absolute; bottom: 2px; right: 2px; width: 10px; height: 10px; background: var(--green); border: 2px solid white; border-radius: 50%; }
        
        .chat-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #f5f5f5; cursor: pointer; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState("hub");
            const [activeChat, setActiveChat] = useState(null);
            const [chatName, setChatName] = useState("");
            const [myChats, setMyChats] = useState([]);
            const [onlineUsers, setOnlineUsers] = useState([]);
            const [messages, setMessages] = useState([]);
            const [text, setText] = useState("");
            const [search, setSearch] = useState("");
            const [isRecording, setIsRecording] = useState(false);
            const [isPartnerTyping, setIsPartnerTyping] = useState(false);
            
            const mediaRecorder = useRef(null);
            const audioChunks = useRef([]);
            const chatEndRef = useRef(null);

            // Auth listener
            useEffect(() => {
                return window.fb.onAuthStateChanged(window.fb.auth, u => setUser(u));
            }, []);

            // Presence & Online list
            useEffect(() => {
                if (user) {
                    const pRef = window.fb.ref(window.fb.db, 'presence');
                    return window.fb.onValue(pRef, s => {
                        const val = s.val() || {};
                        setOnlineUsers(Object.entries(val).map(([uid, d]) => ({ uid, ...d })));
                    });
                }
            }, [user]);

            // My Chats list
            useEffect(() => {
                if (user) {
                    return window.fb.onValue(window.fb.ref(window.fb.db, `userChats/${user.uid}`), s => {
                        const val = s.val();
                        setMyChats(val ? Object.values(val).sort((a,b) => b.lastTime - a.lastTime) : []);
                    });
                }
            }, [user]);

            // Chat Messages & Typing
            useEffect(() => {
                if (user && view === "chat" && activeChat) {
                    const chatId = [user.uid, activeChat].sort().join("_");
                    window.fb.update(window.fb.ref(window.fb.db, `userChats/${user.uid}/${activeChat}`), { unread: 0 });
                    
                    const mRef = window.fb.ref(window.fb.db, `messages/private/${chatId}`);
                    const unsubM = window.fb.onValue(mRef, s => {
                        setMessages(s.val() ? Object.values(s.val()) : []);
                        setTimeout(() => chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
                    });

                    const unsubT = window.fb.onValue(window.fb.ref(window.fb.db, `typing/${chatId}/${activeChat}`), s => {
                        setIsPartnerTyping(s.val() === true);
                    });

                    return () => { unsubM(); unsubT(); };
                }
            }, [view, activeChat, user]);

            const handleTyping = (e) => {
                setText(e.target.value);
                const chatId = [user.uid, activeChat].sort().join("_");
                window.fb.set(window.fb.ref(window.fb.db, `typing/${chatId}/${user.uid}`), true);
                clearTimeout(window.tOut);
                window.tOut = setTimeout(() => {
                    window.fb.set(window.fb.ref(window.fb.db, `typing/${chatId}/${user.uid}`), false);
                }, 2000);
            };

            const sendMessage = () => {
                if (!text.trim()) return;
                const time = Date.now();
                const chatId = [user.uid, activeChat].sort().join("_");
                const msg = { text: text.trim(), uid: user.uid, time };
                
                window.fb.push(window.fb.ref(window.fb.db, `messages/private/${chatId}`), msg);
                updateChatHeads(text.trim(), time);
                setText("");
            };

            const updateChatHeads = async (lastMsg, time) => {
                const updateObj = { lastMsg, lastTime: time, partnerName: chatName, partnerUid: activeChat };
                window.fb.update(window.fb.ref(window.fb.db, `userChats/${user.uid}/${activeChat}`), updateObj);
                
                const pRef = window.fb.ref(window.fb.db, `userChats/${activeChat}/${user.uid}`);
                const snap = await window.fb.get(pRef);
                window.fb.update(pRef, { 
                    lastMsg, lastTime: time, partnerName: user.displayName, partnerUid: user.uid,
                    unread: (snap.val()?.unread || 0) + 1
                });
            };

            const startRecording = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder.current = new MediaRecorder(stream);
                    audioChunks.current = [];
                    mediaRecorder.current.ondataavailable = e => audioChunks.current.push(e.data);
                    mediaRecorder.current.onstop = () => {
                        const blob = new Blob(audioChunks.current, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(blob);
                        reader.onloadend = () => {
                            const base64 = reader.result;
                            const time = Date.now();
                            const chatId = [user.uid, activeChat].sort().join("_");
                            window.fb.push(window.fb.ref(window.fb.db, `messages/private/${chatId}`), { audio: base64, uid: user.uid, time });
                            updateChatHeads("üéô –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ", time);
                        };
                    };
                    mediaRecorder.current.start();
                    setIsRecording(true);
                } catch (e) { alert("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"); }
            };

            const stopRecording = () => {
                if (mediaRecorder.current && isRecording) {
                    mediaRecorder.current.stop();
                    mediaRecorder.current.stream.getTracks().forEach(t => t.stop());
                    setIsRecording(false);
                }
            };

            const changeName = async () => {
                const n = prompt("–ù–æ–≤–æ–µ –∏–º—è:", user.displayName);
                if (n && n.trim() !== user.displayName) {
                    if (confirm("–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å?")) {
                        await window.fb.updateProfile(window.fb.auth.currentUser, { displayName: n.trim() });
                        await window.fb.update(window.fb.ref(window.fb.db, `presence/${user.uid}`), { name: n.trim() });
                        window.location.reload();
                    }
                }
            };

            if (!user) return (
                <div className="login-screen">
                    <div className="login-card">
                        <h1 style={{color:'var(--main-blue)'}}>AstikChat</h1>
                        <button className="btn btn-online" style={{width:'100%', padding:15}} onClick={() => window.fb.signInWithPopup(window.fb.auth, new window.fb.GoogleAuthProvider())}>–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
                    </div>
                </div>
            );

            if (view === "hub") return (
                <>
                    <header>
                        <h1 className="logo">AstikChat</h1>
                        <button className="btn" onClick={() => confirm("–í—ã–π—Ç–∏?") && window.fb.signOut(window.fb.auth)}>–í—ã—Ö–æ–¥</button>
                    </header>
                    <div className="top-menu">
                        <div className="menu-row">
                            <div style={{display:'flex', alignItems:'center', gap:10}}>
                                <div className="avatar" style={{background:'var(--main-blue)'}}>{user.displayName?.[0]}</div>
                                <div>
                                    <b>{user.displayName}</b><br/>
                                    <span onClick={changeName} style={{fontSize:'0.7rem', color:'var(--main-blue)', cursor:'pointer'}}>–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è ‚úé</span>
                                </div>
                            </div>
                            <button className="btn btn-online" onClick={() => window.fb.set(window.fb.ref(window.fb.db, `presence/${user.uid}`), {name: user.displayName, lastSeen: Date.now()})}>–Ø –æ–Ω–ª–∞–π–Ω</button>
                        </div>
                        <input className="input-bar" style={{width:'100%', border:'none'}} placeholder="üîç –ü–æ–∏—Å–∫..." value={search} onChange={e => setSearch(e.target.value)} />
                    </div>
                    <div className="content-scroll">
                        <div style={{padding:15, display:'flex', gap:10, overflowX:'auto'}}>
                            {onlineUsers.map(u => (
                                <div key={u.uid} onClick={() => u.uid !== user.uid && (setActiveChat(u.uid), setChatName(u.name), setView("chat"))} style={{textAlign:'center', minWidth:60}}>
                                    <div className="avatar" style={{margin:'0 auto'}}>{u.name?.[0]}<div className="online-indicator"></div></div>
                                    <span style={{fontSize:'0.7rem'}}>{u.uid === user.uid ? "–Ø" : u.name}</span>
                                </div>
                            ))}
                        </div>
                        {myChats.filter(c => c.partnerName?.toLowerCase().includes(search.toLowerCase())).map(c => (
                            <div key={c.partnerUid} className="chat-item" onClick={() => {setActiveChat(c.partnerUid); setChatName(c.partnerName); setView("chat");}}>
                                <div className="avatar">{c.partnerName?.[0]}</div>
                                <div style={{flex:1, marginLeft:15}}>
                                    <b>{c.partnerName}</b><br/>
                                    <span style={{color:'#666', fontSize:'0.9rem'}}>{c.lastMsg}</span>
                                </div>
                                {c.unread > 0 && <div style={{background:'var(--red)', color:'white', borderRadius:'50%', padding:'2px 8px', fontSize:'0.7rem'}}>{c.unread}</div>}
                            </div>
                        ))}
                    </div>
                </>
            );

            return (
                <>
                    <header>
                        <div style={{display:'flex', alignItems:'center', gap:10}}>
                            <span onClick={() => setView("hub")} style={{fontSize:'1.5rem', cursor:'pointer'}}>‚Üê</span>
                            <div className="avatar" style={{width:35, height:35}}>{chatName?.[0]}</div>
                            <div>
                                <b>{chatName}</b>
                                {isPartnerTyping && <div style={{fontSize:'0.7rem', color:'#adff2f'}}>–ø–µ—á–∞—Ç–∞–µ—Ç...</div>}
                            </div>
                        </div>
                    </header>
                    <div className="chat-area">
                        {messages.map((m, i) => (
                            <div key={i} className={`msg-wrap ${m.uid === user.uid ? 'my-wrap' : ''}`}>
                                <div className={`msg-bubble ${m.uid === user.uid ? 'my-bubble' : 'other-bubble'}`}>
                                    {m.audio ? <audio src={m.audio} controls className="audio-msg" /> : <span>{m.text}</span>}
                                    <div className="msg-time">{new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                                </div>
                            </div>
                        ))}
                        <div ref={chatEndRef}></div>
                    </div>
                    <div className="input-bar">
                        <input value={text} onChange={handleTyping} placeholder={isRecording ? "–ó–∞–ø–∏—Å—å..." : "–°–æ–æ–±—â–µ–Ω–∏–µ..."} disabled={isRecording} onKeyDown={e => e.key === 'Enter' && sendMessage()} />
                        {text.trim() === "" ? (
                            <button className={`mic-btn ${isRecording ? 'recording' : ''}`} onMouseDown={startRecording} onMouseUp={stopRecording} onTouchStart={startRecording} onTouchEnd={stopRecording}>üé§</button>
                        ) : (
                            <button className="send-btn" onClick={sendMessage}>‚û§</button>
                        )}
                    </div>
                </>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
