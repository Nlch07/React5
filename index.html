<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Astik Chat Hub</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInAnonymously, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, onValue, set, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDppgpIDC7lsqkyKanmWnt6aRmkV8sRfck",
            authDomain: "astikchat-2356f.firebaseapp.com",
            databaseURL: "https://astikchat-2356f-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "astikchat-2356f",
            storageBucket: "astikchat-2356f.firebasestorage.app",
            messagingSenderId: "481971458258",
            appId: "1:481971458258:web:131953007028cc61be5d0b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const googleProvider = new GoogleAuthProvider();

        window.fb = { auth, db, googleProvider, signInWithPopup, signInAnonymously, signOut, onAuthStateChanged, updateProfile, ref, push, onValue, set, update, serverTimestamp };
    </script>

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: -apple-system, sans-serif; background-color: #f0f2f5; height: 100dvh; overflow: hidden; }
        #root { width: 100%; height: 100%; max-width: 500px; margin: 0 auto; background: white; display: flex; flex-direction: column; }
        
        header { background: #075e54; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Список чатов */
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { 
            display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; cursor: pointer;
            transition: background 0.2s;
        }
        .chat-item:active { background: #f5f5f5; }
        .chat-info { flex: 1; margin-left: 15px; }
        .chat-name { font-weight: bold; font-size: 1rem; }
        .chat-last-msg { font-size: 0.85rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        
        /* Уведомления */
        .badge { 
            background: #25d366; color: white; font-size: 0.7rem; 
            padding: 2px 6px; border-radius: 10px; margin-left: auto; 
        }

        /* Окно чата */
        .chat-window { flex: 1; display: flex; flex-direction: column; background: #e5ddd5; }
        .messages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 5px; }
        
        .msg-container { display: flex; align-items: flex-end; margin-bottom: 4px; }
        .my-msg-container { justify-content: flex-end; }
        .msg { background: white; padding: 8px 12px; border-radius: 12px; max-width: 80%; font-size: 0.95rem; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .my-msg { background: #dcf8c6; border-bottom-right-radius: 2px; }
        
        .input-area { background: #f0f0f0; padding: 10px; display: flex; gap: 8px; align-items: center; }
        input { flex: 1; border: none; padding: 12px; border-radius: 20px; outline: none; font-size: 16px; }
        
        .avatar { 
            width: 45px; height: 45px; border-radius: 50%; color: white; 
            display: flex; justify-content: center; align-items: center; font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const getColor = (uid) => {
            let hash = 0;
            for (let i = 0; i < uid.length; i++) hash = uid.charCodeAt(i) + ((hash << 5) - hash);
            return `hsl(${Math.abs(hash) % 360}, 60%, 40%)`;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState("hub"); // "hub" или "chat"
            const [activeChat, setActiveChat] = useState("public");
            const [chatPartnerName, setChatPartnerName] = useState("");
            const [myChats, setMyChats] = useState([]);
            const [messages, setMessages] = useState([]);
            const [text, setText] = useState("");
            const scrollRef = useRef();

            useEffect(() => {
                return window.fb.onAuthStateChanged(window.fb.auth, (u) => setUser(u));
            }, []);

            // Слушатель списка чатов пользователя
            useEffect(() => {
                if (!user || !user.displayName) return;
                const chatsRef = window.fb.ref(window.fb.db, `userChats/${user.uid}`);
                return window.fb.onValue(chatsRef, (snap) => {
                    const data = snap.val();
                    if (data) {
                        const sorted = Object.values(data).sort((a, b) => b.lastTime - a.lastTime);
                        setMyChats(sorted);
                    }
                });
            }, [user]);

            // Слушатель сообщений
            useEffect(() => {
                if (!user || view !== "chat") return;
                let path = activeChat === "public" ? 'messages/public' : `messages/private/${[user.uid, activeChat].sort().join("_")}`;
                const msgsRef = window.fb.ref(window.fb.db, path);
                return window.fb.onValue(msgsRef, (snap) => {
                    const data = snap.val();
                    setMessages(data ? Object.values(data) : []);
                    setTimeout(() => scrollRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
                });
            }, [user, view, activeChat]);

            const sendMessage = () => {
                if (!text.trim()) return;
                const time = Date.now();
                const chatId = activeChat === "public" ? "public" : [user.uid, activeChat].sort().join("_");
                const path = activeChat === "public" ? 'messages/public' : `messages/private/${chatId}`;

                // 1. Пушим сообщение
                window.fb.push(window.fb.ref(window.fb.db, path), {
                    text, uid: user.uid, name: user.displayName, time
                });

                // 2. Обновляем инфо о последнем сообщении для обоих (если личка)
                if (activeChat !== "public") {
                    const updateData = {
                        lastMsg: text,
                        lastTime: time,
                        partnerName: chatPartnerName,
                        partnerUid: activeChat
                    };
                    window.fb.update(window.fb.ref(window.fb.db, `userChats/${user.uid}/${activeChat}`), updateData);
                    
                    const partnerUpdate = {
                        lastMsg: text,
                        lastTime: time,
                        partnerName: user.displayName,
                        partnerUid: user.uid
                    };
                    window.fb.update(window.fb.ref(window.fb.db, `userChats/${activeChat}/${user.uid}`), partnerUpdate);
                }
                setText("");
            };

            const openChat = (uid, name) => {
                setActiveChat(uid);
                setChatPartnerName(name);
                setView("chat");
            };

            if (!user) return <div style={{padding:20, textAlign:'center'}}>
                <h1>Astik Chat</h1>
                <button onClick={() => window.fb.signInWithPopup(window.fb.auth, window.fb.googleProvider)}>Google Login</button>
            </div>;

            if (view === "hub") {
                return (
                    <>
                        <header>
                            <b>Astik Chat</b>
                            <button onClick={() => window.fb.signOut(window.fb.auth)} style={{color:'white', background:'none', border:'none'}}>Выход</button>
                        </header>
                        <div className="chat-list">
                            <div className="chat-item" onClick={() => openChat("public", "Общий чат")}>
                                <div className="avatar" style={{background: '#075e54'}}>#</div>
                                <div className="chat-info">
                                    <div className="chat-name">Общий чат</div>
                                    <div className="chat-last-msg">Все пользователи здесь</div>
                                </div>
                            </div>
                            
                            {myChats.map(chat => (
                                <div key={chat.partnerUid} className="chat-item" onClick={() => openChat(chat.partnerUid, chat.partnerName)}>
                                    <div className="avatar" style={{background: getColor(chat.partnerUid)}}>{chat.partnerName[0]}</div>
                                    <div className="chat-info">
                                        <div className="chat-name">{chat.partnerName}</div>
                                        <div className="chat-last-msg">{chat.lastMsg}</div>
                                    </div>
                                    <div className="chat-time" style={{fontSize:'0.7rem', color:'#999'}}>
                                        {new Date(chat.lastTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </>
                );
            }

            return (
                <div className="chat-window">
                    <header>
                        <span onClick={() => setView("hub")} style={{cursor:'pointer'}}>← Назад</span>
                        <b>{chatPartnerName}</b>
                        <span></span>
                    </header>
                    <div className="messages">
                        {messages.map((m, i) => (
                            <div key={i} className={`msg-container ${m.uid === user.uid ? 'my-msg-container' : ''}`}>
                                <div className={`msg ${m.uid === user.uid ? 'my-msg' : ''}`}>
                                    {activeChat === "public" && m.uid !== user.uid && 
                                        <div style={{fontSize:'0.7rem', fontWeight:'bold', color: getColor(m.uid), marginBottom:3}}
                                             onClick={() => openChat(m.uid, m.name)}>
                                            {m.name}
                                        </div>
                                    }
                                    {m.text}
                                    <div style={{fontSize:'0.6rem', color:'#888', textAlign:'right'}}>{new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                                </div>
                            </div>
                        ))}
                        <div ref={scrollRef} />
                    </div>
                    <div className="input-area">
                        <input value={text} onChange={e => setText(e.target.value)} onKeyPress={e => e.key === 'Enter' && sendMessage()} placeholder="Сообщение..." />
                        <button onClick={sendMessage} style={{background:'#075e54', border:'none', color:'white', width:40, height:40, borderRadius:'50%'}}>➤</button>
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
